<!DOCTYPE html>
<html>
<head>
    <title>Cross Platform Audio Compatibility Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <meta name="apple-mobile-web-app-capable" content="yes" />

    <!-- bridgeit.js UNSTABLE VERSION -->
    <script type="text/javascript" src="http://bridgeit.github.io/bridgeit.js/src/bridgeit.js"></script>
    <!-- bridgeit.js STABLE VERSION
    <script type="text/javascript" src="http://api.bridgeit.mobi/bridgeit/bridgeit.js"></script -->

    <link href="http://bridgeit.github.io/demo-jqm/css/mobile.css" rel="stylesheet" type="text/css"/>
    <link href="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css" rel="stylesheet" type="text/css">

    <style type="text/css">
        #micBtn {width:165px;}
    </style>
</head>

<body>
    <script type="text/javascript">
        var echoService = "http://api.bridgeit.mobi/echo/";
        var pushService = "http://api.bridgeit.mobi/push/";
        var pushApiKey = "197EBF31-40CD-444F-826F-10158A0F3581";
        var uploadedAudio = [ ];
        var userDevice = "";
        var audioPushReady;
        var xhr = new XMLHttpRequest();
        var userAgent = navigator.userAgent;

        function updateAudioList() {
            console.log('Audio updateAudioList');
            xhr = new XMLHttpRequest();
            xhr.open("GET", echoService + "list/audiotest",false);
            xhr.send();
            try {
                uploadedAudio = JSON.parse(xhr.responseText);
                var uploadedAudioList = "";
                var device = "";
                for (var i=uploadedAudio.length-1; i>0; i--) {
                    device = uploadedAudio[i].device;
                    uploadedAudio[i].audio = uploadedAudio[i].audio.split("\"").join(""); //strip quotes
                    uploadedAudioList = uploadedAudioList +
                    device + ": " +
                    "<audio controls preload='auto' src='" + uploadedAudio[i].audio + "'></audio><br>";
                    if (i == uploadedAudio.length - 10) { break; } //only show last 10 uploads
                }
                document.getElementById("uploadedAudio").innerHTML = uploadedAudioList;
            }
            catch (e) {
                alert(e);
            };
        }

        if (!audioPushReady)  {
            bridgeit.usePushService(pushService, pushApiKey);
            bridgeit.addPushListener("audioTest","onReceiveAudioPush");
            audioPushReady = true;
        }

        function onReceiveAudioPush(){
            console.log("Audio Push received");
            updateAudioList();
        }

        // try and detect device
        if (userAgent.indexOf("Android") > -1) {
            userAgent = userAgent.substring(userAgent.indexOf("Android"));
            userDevice = userAgent.substring(0,userAgent.indexOf(";"));
        }
        else if (userAgent.indexOf("iPhone") > -1) {
            userDevice = "iPhone";
            if (userAgent.indexOf("OS 6_") > - 1) {
                userDevice = userDevice + " iOS6";
            }
            else if (userAgent.indexOf("OS 7_") > - 1) {
                userDevice = userDevice + " iOS7";
            }
        }
        else if (userAgent.indexOf("iPad") > -1) {
            userDevice = "iPad";
            if (userAgent.indexOf("OS 6_") > - 1) {
                userDevice = userDevice + " iOS6";
            }
            else if (userAgent.indexOf("OS 7_") > - 1) {
                userDevice = userDevice + " iOS7";
            }
        }
        else if (userAgent.indexOf("iPod") > -1) {
            userDevice = "iPod";
            if (userAgent.indexOf("OS 6_") > - 1) {
                userDevice = userDevice + " iOS6";
            }
            else if (userAgent.indexOf("OS 7_") > - 1) {
                userDevice = userDevice + " iOS7";
            }
        }
        else if (userAgent.indexOf("BB10") > -1) {
            userDevice = "Blackberry 10";
        }
        else if (userAgent.indexOf("BlackBerry") > -1) {
            userDevice = "BlackBerry (Older than 10)";
        }
        else if (userAgent.indexOf('IEMobile') > -1
             || (userAgent.indexOf('MSIE 10') > -1
             && typeof window.orientation !== 'undefined')) {
            userDevice = "Windows Phone 8";
        }
        else {
            userDevice = "Unknown Device";
        }

        function onAfterAudioCapture(event){
            if (event.response)  {
                postResponse(event.response);
            }
        }

        function postResponse(audioSrc) {
            xhr = new XMLHttpRequest();
            xhr.open("POST", echoService + "list/audiotest",false);
            xhr.setRequestHeader("Content-type","application/json; charset=utf-8");
            var audio = {
                audio: audioSrc,
                device: userDevice
            }
            xhr.send(JSON.stringify(audio));
            bridgeit.push("audioTest", null);
        }

    </script>

    <a id='micBtn' type="button" class="btn ui-btn ui-shadow ui-btn-corner-all ui-btn-up-c"
       onclick="bridgeit.microphone('micBtn', 'onAfterAudioCapture', {postURL: echoService + 'blob'});">
        <span class="ui-btn-inner">
            <span class="ui-btn-text">Record Audio</span>
        </span>
    </a>
    <h3>Uploaded Audio</h3>
    <span id="uploadedAudio"></span>
    <script type="text/javascript">
        updateAudioList();
    </script>
</body>
</html>

